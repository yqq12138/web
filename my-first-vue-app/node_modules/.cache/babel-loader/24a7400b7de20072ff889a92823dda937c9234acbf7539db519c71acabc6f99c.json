{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nexport default {\n  data() {\n    return {\n      messages: [],\n      userInput: '',\n      loading: false\n    };\n  },\n  methods: {\n    handleImageUpload(event) {\n      const file = event.target.files[0];\n      if (!file) return;\n      const reader = new FileReader();\n      reader.onload = e => {\n        const base64Data = e.target.result.split(',')[1];\n        const mimeType = file.type;\n        const initialMessage = {\n          role: \"user\",\n          content: [{\n            type: \"text\",\n            text: \"请分析这张图片中的工件是否存在异常。如果存在异常，请以JSON格式返回分析结果，包括异常描述和异常部位的坐标（格式：{\\\"x1\\\": 左上角x, \\\"y1\\\": 左上角y, \\\"x2\\\": 右下角x, \\\"y2\\\": 右下角y}）。例如：{\\\"analysis\\\": \\\"发现裂纹\\\", \\\"coordinates\\\": {\\\"x1\\\": 100, \\\"y1\\\": 200, \\\"x2\\\": 150, \\\"y2\\\": 250}}\"\n          }, {\n            type: \"image_url\",\n            image_url: {\n              url: `data:${mimeType};base64,${base64Data}`\n            }\n          }]\n        };\n        this.messages.push(initialMessage);\n        this.sendToAI();\n      };\n      reader.readAsDataURL(file);\n    },\n    sendMessage() {\n      const text = this.userInput.trim();\n      if (!text) return;\n      this.messages.push({\n        role: \"user\",\n        content: [{\n          type: \"text\",\n          text\n        }]\n      });\n      this.userInput = '';\n      this.sendToAI();\n    },\n    sendToAI() {\n      this.loading = true;\n      fetch('/api/detection/chat', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          messages: this.messages\n        })\n      }).then(res => res.json()).then(data => {\n        if (data.success) {\n          this.messages = data.messages;\n          this.$nextTick(() => {\n            const el = this.$refs.chatHistory;\n            if (el) el.scrollTop = el.scrollHeight;\n          });\n        } else {\n          alert(\"错误: \" + data.error);\n        }\n      }).catch(err => alert(\"网络错误: \" + err)).finally(() => {\n        this.loading = false;\n      });\n    },\n    extractText(content) {\n      if (Array.isArray(content)) {\n        return content.map(c => c.type === 'text' ? c.text : '').join(' ').trim();\n      } else if (typeof content === 'string') {\n        return content;\n      }\n      return '';\n    }\n  }\n};","map":{"version":3,"names":["data","messages","userInput","loading","methods","handleImageUpload","event","file","target","files","reader","FileReader","onload","e","base64Data","result","split","mimeType","type","initialMessage","role","content","text","image_url","url","push","sendToAI","readAsDataURL","sendMessage","trim","fetch","method","headers","body","JSON","stringify","then","res","json","success","$nextTick","el","$refs","chatHistory","scrollTop","scrollHeight","alert","error","catch","err","finally","extractText","Array","isArray","map","c","join"],"sources":["D:\\web\\qianrushi\\my-first-vue-app\\src\\views\\ChatWithAI.vue"],"sourcesContent":["<template>\r\n  <div class=\"container\">\r\n    <div class=\"chat-box\">\r\n      <h1>AI图片对话系统</h1>\r\n\r\n      <div class=\"upload-section\">\r\n        <input type=\"file\" accept=\"image/*\" @change=\"handleImageUpload\">\r\n        <p>（请先上传图片开始对话）</p>\r\n      </div>\r\n\r\n      <div class=\"chat-history\" ref=\"chatHistory\">\r\n        <div v-for=\"(msg, index) in messages\" :key=\"index\" :class=\"['message', msg.role === 'user' ? 'user-message' : 'ai-message']\">\r\n          <template v-if=\"msg.role === 'user'\">\r\n            <span class=\"prefix\">你：</span>{{ extractText(msg.content) }}\r\n          </template>\r\n          <template v-else>\r\n            <template v-if=\"typeof msg.content === 'object' && msg.content.analysis\">\r\n              <div class=\"analysis-text\">分析结果: {{ msg.content.analysis }}</div>\r\n              <div class=\"coordinates-text\">\r\n                异常坐标: ({{ msg.content.coordinates.x1 }}, {{ msg.content.coordinates.y1 }}) 至 ({{ msg.content.coordinates.x2 }}, {{ msg.content.coordinates.y2 }})\r\n              </div>\r\n              <div class=\"image-container\">\r\n                <img v-if=\"msg.content.original_image\" :src=\"msg.content.original_image\" alt=\"原图\" class=\"original-image\" />\r\n                <img v-if=\"msg.content.annotated_image\" :src=\"msg.content.annotated_image\" alt=\"标注图\" class=\"annotated-image\" />\r\n              </div>\r\n            </template>\r\n            <template v-else>\r\n              <span class=\"prefix\">助手：</span>{{ extractText(msg.content) }}\r\n            </template>\r\n          </template>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"input-area\">\r\n        <input type=\"text\" v-model=\"userInput\" placeholder=\"输入消息...\" @keyup.enter=\"sendMessage\" />\r\n        <button @click=\"sendMessage\" :disabled=\"loading\">{{ loading ? '发送中...' : '发送' }}</button>\r\n      </div>\r\n    </div>\r\n    <div class=\"background-decor\"></div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nexport default {\r\n  data() {\r\n    return {\r\n      messages: [],\r\n      userInput: '',\r\n      loading: false\r\n    };\r\n  },\r\n  methods: {\r\n    handleImageUpload(event) {\r\n      const file = event.target.files[0];\r\n      if (!file) return;\r\n\r\n      const reader = new FileReader();\r\n      reader.onload = (e) => {\r\n        const base64Data = e.target.result.split(',')[1];\r\n        const mimeType = file.type;\r\n\r\n        const initialMessage = {\r\n          role: \"user\",\r\n          content: [\r\n            {\r\n              type: \"text\",\r\n              text: \"请分析这张图片中的工件是否存在异常。如果存在异常，请以JSON格式返回分析结果，包括异常描述和异常部位的坐标（格式：{\\\"x1\\\": 左上角x, \\\"y1\\\": 左上角y, \\\"x2\\\": 右下角x, \\\"y2\\\": 右下角y}）。例如：{\\\"analysis\\\": \\\"发现裂纹\\\", \\\"coordinates\\\": {\\\"x1\\\": 100, \\\"y1\\\": 200, \\\"x2\\\": 150, \\\"y2\\\": 250}}\"\r\n            },\r\n            {\r\n              type: \"image_url\",\r\n              image_url: {\r\n                url: `data:${mimeType};base64,${base64Data}`\r\n              }\r\n            }\r\n          ]\r\n        };\r\n\r\n        this.messages.push(initialMessage);\r\n        this.sendToAI();\r\n      };\r\n      reader.readAsDataURL(file);\r\n    },\r\n    sendMessage() {\r\n      const text = this.userInput.trim();\r\n      if (!text) return;\r\n\r\n      this.messages.push({\r\n        role: \"user\",\r\n        content: [{ type: \"text\", text }]\r\n      });\r\n\r\n      this.userInput = '';\r\n      this.sendToAI();\r\n    },\r\n    sendToAI() {\r\n      this.loading = true;\r\n      fetch('/api/detection/chat', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({ messages: this.messages })\r\n      })\r\n          .then(res => res.json())\r\n          .then(data => {\r\n            if (data.success) {\r\n              this.messages = data.messages;\r\n              this.$nextTick(() => {\r\n                const el = this.$refs.chatHistory;\r\n                if (el) el.scrollTop = el.scrollHeight;\r\n              });\r\n            } else {\r\n              alert(\"错误: \" + data.error);\r\n            }\r\n          })\r\n          .catch(err => alert(\"网络错误: \" + err))\r\n          .finally(() => {\r\n            this.loading = false;\r\n          });\r\n    },\r\n    extractText(content) {\r\n      if (Array.isArray(content)) {\r\n        return content.map(c => c.type === 'text' ? c.text : '').join(' ').trim();\r\n      } else if (typeof content === 'string') {\r\n        return content;\r\n      }\r\n      return '';\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n.container {\r\n  position: absolute;\r\n  top: 60px;\r\n  left: 0;\r\n  right: 0;\r\n  bottom: 0;\r\n  background: linear-gradient(to right, #1c1c1c, #2a2a2a);\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: flex-start;\r\n  padding: 40px 20px;\r\n  overflow: auto;\r\n  box-sizing: border-box;\r\n}\r\n\r\n.chat-box {\r\n  width: 100%;\r\n  max-width: 700px;\r\n  background: rgba(0, 0, 0, 0.3);\r\n  border: 1px solid #00eaff55;\r\n  border-radius: 12px;\r\n  box-shadow: 0 0 20px rgba(0, 234, 255, 0.1);\r\n  padding: 30px;\r\n  box-sizing: border-box;\r\n}\r\n\r\n.chat-box h1 {\r\n  font-size: 24px;\r\n  color: #00eaff;\r\n  margin-bottom: 20px;\r\n  text-align: center;\r\n}\r\n\r\n.upload-section {\r\n  margin-bottom: 20px;\r\n  text-align: center;\r\n  color: #aaa;\r\n}\r\n\r\n.chat-history {\r\n  max-height: 400px;\r\n  overflow-y: auto;\r\n  padding-right: 8px;\r\n  margin-bottom: 20px;\r\n  background: rgba(255, 255, 255, 0.03);\r\n  padding: 20px;\r\n  border-radius: 12px;\r\n  border: 1px solid #00eaff22;\r\n  box-shadow: inset 0 0 10px rgba(0, 234, 255, 0.05);\r\n}\r\n\r\n.message {\r\n  margin-bottom: 16px;\r\n  padding: 12px 16px;\r\n  border-radius: 10px;\r\n  max-width: 80%;\r\n  word-break: break-word;\r\n  line-height: 1.6;\r\n  font-size: 15px;\r\n}\r\n\r\n.user-message {\r\n  background: #003344;\r\n  color: #bbdefb;\r\n  margin-left: auto;\r\n  text-align: right;\r\n}\r\n\r\n.ai-message {\r\n  background: #00261f;\r\n  color: #c8e6c9;\r\n  margin-right: auto;\r\n  text-align: left;\r\n}\r\n\r\n.prefix {\r\n  font-weight: bold;\r\n  margin-right: 6px;\r\n}\r\n\r\n.analysis-text {\r\n  font-weight: bold;\r\n  margin-bottom: 8px;\r\n  color: #00ffc3;\r\n}\r\n\r\n.coordinates-text {\r\n  color: #aaf0ff;\r\n  font-size: 14px;\r\n  margin-bottom: 10px;\r\n}\r\n\r\n.image-container {\r\n  display: flex;\r\n  flex-wrap: wrap;\r\n  gap: 10px;\r\n  margin-top: 10px;\r\n}\r\n\r\n.original-image,\r\n.annotated-image {\r\n  max-width: 200px;\r\n  border-radius: 8px;\r\n  border: 1px solid #00eaff33;\r\n  box-shadow: 0 0 8px rgba(0, 234, 255, 0.2);\r\n}\r\n\r\n.input-area {\r\n  display: flex;\r\n  gap: 10px;\r\n  width: 100%;\r\n}\r\n\r\n.input-area input[type=\"text\"] {\r\n  flex: 1;\r\n  padding: 10px;\r\n  border: 1px solid #00eaff55;\r\n  border-radius: 8px;\r\n  background: #222;\r\n  color: #fff;\r\n  outline: none;\r\n}\r\n\r\n.input-area button {\r\n  padding: 10px 20px;\r\n  background: #00eaff;\r\n  border: none;\r\n  border-radius: 8px;\r\n  color: #000;\r\n  font-weight: bold;\r\n  cursor: pointer;\r\n  transition: background 0.3s;\r\n}\r\n\r\n.input-area button:hover {\r\n  background: #00bcd4;\r\n}\r\n\r\ninput[type=\"file\"] {\r\n  margin: 10px 0;\r\n  color: #fff;\r\n}\r\n\r\n.background-decor {\r\n  position: absolute;\r\n  bottom: -100px;\r\n  left: -150px;\r\n  width: 400px;\r\n  height: 400px;\r\n  background: radial-gradient(circle at center, rgba(0, 234, 255, 0.2), transparent);\r\n  filter: blur(120px);\r\n  pointer-events: none;\r\n}\r\n</style>\r\n"],"mappings":";;;AA2CA,eAAe;EACbA,IAAIA,CAAA,EAAG;IACL,OAAO;MACLC,QAAQ,EAAE,EAAE;MACZC,SAAS,EAAE,EAAE;MACbC,OAAO,EAAE;IACX,CAAC;EACH,CAAC;EACDC,OAAO,EAAE;IACPC,iBAAiBA,CAACC,KAAK,EAAE;MACvB,MAAMC,IAAG,GAAID,KAAK,CAACE,MAAM,CAACC,KAAK,CAAC,CAAC,CAAC;MAClC,IAAI,CAACF,IAAI,EAAE;MAEX,MAAMG,MAAK,GAAI,IAAIC,UAAU,CAAC,CAAC;MAC/BD,MAAM,CAACE,MAAK,GAAKC,CAAC,IAAK;QACrB,MAAMC,UAAS,GAAID,CAAC,CAACL,MAAM,CAACO,MAAM,CAACC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;QAChD,MAAMC,QAAO,GAAIV,IAAI,CAACW,IAAI;QAE1B,MAAMC,cAAa,GAAI;UACrBC,IAAI,EAAE,MAAM;UACZC,OAAO,EAAE,CACP;YACEH,IAAI,EAAE,MAAM;YACZI,IAAI,EAAE;UACR,CAAC,EACD;YACEJ,IAAI,EAAE,WAAW;YACjBK,SAAS,EAAE;cACTC,GAAG,EAAE,QAAQP,QAAQ,WAAWH,UAAU;YAC5C;UACF;QAEJ,CAAC;QAED,IAAI,CAACb,QAAQ,CAACwB,IAAI,CAACN,cAAc,CAAC;QAClC,IAAI,CAACO,QAAQ,CAAC,CAAC;MACjB,CAAC;MACDhB,MAAM,CAACiB,aAAa,CAACpB,IAAI,CAAC;IAC5B,CAAC;IACDqB,WAAWA,CAAA,EAAG;MACZ,MAAMN,IAAG,GAAI,IAAI,CAACpB,SAAS,CAAC2B,IAAI,CAAC,CAAC;MAClC,IAAI,CAACP,IAAI,EAAE;MAEX,IAAI,CAACrB,QAAQ,CAACwB,IAAI,CAAC;QACjBL,IAAI,EAAE,MAAM;QACZC,OAAO,EAAE,CAAC;UAAEH,IAAI,EAAE,MAAM;UAAEI;QAAK,CAAC;MAClC,CAAC,CAAC;MAEF,IAAI,CAACpB,SAAQ,GAAI,EAAE;MACnB,IAAI,CAACwB,QAAQ,CAAC,CAAC;IACjB,CAAC;IACDA,QAAQA,CAAA,EAAG;MACT,IAAI,CAACvB,OAAM,GAAI,IAAI;MACnB2B,KAAK,CAAC,qBAAqB,EAAE;QAC3BC,MAAM,EAAE,MAAM;QACdC,OAAO,EAAE;UAAE,cAAc,EAAE;QAAmB,CAAC;QAC/CC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAC;UAAElC,QAAQ,EAAE,IAAI,CAACA;QAAS,CAAC;MAClD,CAAC,EACImC,IAAI,CAACC,GAAE,IAAKA,GAAG,CAACC,IAAI,CAAC,CAAC,EACtBF,IAAI,CAACpC,IAAG,IAAK;QACZ,IAAIA,IAAI,CAACuC,OAAO,EAAE;UAChB,IAAI,CAACtC,QAAO,GAAID,IAAI,CAACC,QAAQ;UAC7B,IAAI,CAACuC,SAAS,CAAC,MAAM;YACnB,MAAMC,EAAC,GAAI,IAAI,CAACC,KAAK,CAACC,WAAW;YACjC,IAAIF,EAAE,EAAEA,EAAE,CAACG,SAAQ,GAAIH,EAAE,CAACI,YAAY;UACxC,CAAC,CAAC;QACJ,OAAO;UACLC,KAAK,CAAC,MAAK,GAAI9C,IAAI,CAAC+C,KAAK,CAAC;QAC5B;MACF,CAAC,EACAC,KAAK,CAACC,GAAE,IAAKH,KAAK,CAAC,QAAO,GAAIG,GAAG,CAAC,EAClCC,OAAO,CAAC,MAAM;QACb,IAAI,CAAC/C,OAAM,GAAI,KAAK;MACtB,CAAC,CAAC;IACR,CAAC;IACDgD,WAAWA,CAAC9B,OAAO,EAAE;MACnB,IAAI+B,KAAK,CAACC,OAAO,CAAChC,OAAO,CAAC,EAAE;QAC1B,OAAOA,OAAO,CAACiC,GAAG,CAACC,CAAA,IAAKA,CAAC,CAACrC,IAAG,KAAM,MAAK,GAAIqC,CAAC,CAACjC,IAAG,GAAI,EAAE,CAAC,CAACkC,IAAI,CAAC,GAAG,CAAC,CAAC3B,IAAI,CAAC,CAAC;MAC3E,OAAO,IAAI,OAAOR,OAAM,KAAM,QAAQ,EAAE;QACtC,OAAOA,OAAO;MAChB;MACA,OAAO,EAAE;IACX;EACF;AACF,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}